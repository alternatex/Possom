<?xml version="1.0" encoding="UTF-8"?>
<!--
 - Copyright (2005-2006) Schibsted SÃ¸k AS
 - $Id$ 
-->
<project default="war:webapp" xmlns:j="jelly:core" xmlns:ant="jelly:ant" xmlns:maven="jelly:maven">

    <!-- Filter develop / production URLs -->
    <!-- Filter log4j paths -->
    <preGoal name="java:prepare-filesystem" >
        <ant:touch file="build.properties"/>
        <ant:echo message="${line.separator}" file="build.properties" append="true"/>
        <ant:filter filtersfile="build.properties" />
        <ant:filter filtersfile="project.properties"/>
        <ant:filter filtersfile="${target}.properties" />
    </preGoal>

    <preGoal name="war:war-resources">
        <ant:filter filtersfile="${target}.properties" />
        <ant:echo message="Filtering war resources: ${maven.war.src.includes}/tradedoubler/searchbox/*.js"/>
        <ant:copy todir="${maven.war.webapp.dir}" filtering="true" preservelastmodified="true">
            <ant:fileset dir="${maven.war.src}"
                includes="${maven.war.src.includes}/tradedoubler/searchbox/*.js"
                excludes="${maven.war.src.excludes}">
            </ant:fileset>
        </ant:copy>
    </preGoal>

    <preGoal name="java:compile">
        <!-- JavaCC :: QueryParser -->
        <j:set var="maven.javacc.javacc.grammar" value="src/javacc/QueryParserImpl.jj"/>
        <j:set var="maven.javacc.javacc.package" value="no.schibstedsok.front.searchportal.query.parser"/>
        <attainGoal name="javacc:javacc-generate"/>
        <path id="javacc.generated.src" location="target/generated-src/main/java/no/schibstedsok/front/searchportal/query/parser"/> 
        <maven:addPath id="maven.compile.src.set" refid="javacc.generated.src"/>
    
        <!-- Axis -->
        <attainGoal name="axis:compile"/>
        
        <echo> ...java:compile preGoal finished.</echo>
    </preGoal>

    <goal name="deploy" prereqs="war:webapp" >
        <copy todir="${maven.tomcat.home}/webapps">
            <fileset dir="${maven.build.dir}">
                <include name="${pom.artifactId}/**"/>
            </fileset>
        </copy>
    </goal>
    
    
    
    
    <!-- 
      - 1) Keep junit tests logging to seperate files.
      - 2) Ensure search-front-config is available.
     -->
    <preGoal name="test:test-resources">
        <attainGoal name="ensure-config-running"/>
        <attainGoal name="alter-log4j-appenders-for-testing"/>
    </preGoal>
    <postGoal name="test:single"><attainGoal name="restore-log4j-appenders-for-testing"/></postGoal>
    <postGoal name="test:test"><attainGoal name="restore-log4j-appenders-for-testing"/></postGoal>
    
    <goal name="alter-log4j-appenders-for-testing">
        <ant:touch file="build.properties"/>
        <ant:echo message="${line.separator}" file="build.properties" append="true"/>
        <ant:loadproperties srcFile="build.properties" />
        <ant:loadproperties srcFile="project.properties"/>
        <ant:loadproperties srcFile="${target}.properties"/>
        <ant:touch file="target/classes/log4j.properties"/>
        <copy file="target/classes/log4j.properties" tofile="target/classes/log4j.properties.original"/>
        <ant:propertyfile file="target/classes/log4j.properties"> 
          <ant:entry key="log4j.appender.LOG_APPEND.File"   value="${log.directory}/${log.file}.test.log" />
          <ant:entry key="log4j.appender.ERROR_APPEND.File" value="${log.directory}/${log.file}.test.error" />
          <ant:entry key="log4j.appender.DUMP_APPEND.File"  value="${log.directory}/${log.file}.test.dump" />
          <ant:entry key="log4j.appender.SALES_APPEND.File"  value="${log.directory}/${log.file}.test.sales" />
          <ant:entry key="log4j.appender.MARKETING_APPEND.File"  value="${log.directory}/${log.file}.test.marketing" />
          <ant:entry key="log4j.appender.PRODUCT_APPEND.File"  value="${log.directory}/${log.file}.test.product" />
        </ant:propertyfile>
    </goal>
    <goal name="restore-log4j-appenders-for-testing">
        <copy file="target/classes/log4j.properties.original" tofile="target/classes/log4j.properties" overwrite="true"/>
    </goal>
    
    <goal name="ensure-config-running">
        <!-- TODO how to test search-front-config is up and available? -->
    <!--
        <ant:junit failureproperty="search-front-config.unavailable">
            <test name="no.schibstedsok.front.searchportal.configuration.DefaultSiteSearchTabsCreatorTest"/>
        </ant:junit>
        <ant:fail if="search-front-config.unavailable"><br/>
            Unable to obtain configuration resources from search-front-config. 
            Please start this service before trying to build/deploy search-front-html.
        </ant:fail>
    -->
    </goal>
    
    <!-- -->
    <!-- CONTINUUM SPECIFIC TARGETS. Only meant to be run on sch-dev0.dev. Hence the hardcoded paths. -->
    <!-- TODO move to continuum-utility plugin -->
    <!-- -->
    
    <goal name="continuum:site" prereqs="site:deploy">
    </goal>
    
    <goal name="continuum:repository" prereqs="war:war">
        <exec executable="/local/bin/svnlook" outputproperty="svn.revision">
          <arg line="youngest /www/schibstedsok/versys/subversion/search-front-html"/>
        </exec>
        <mkdir dir="/www/schibstedsok/data/httpd/dev.schibstedsok.no_443/htdocs/maven/schibstedsok/wars/search-front-html/${target}/${svn.revision}"/>
        <copy 
            file="${maven.build.dir}/ROOT.war"
            todir="/www/schibstedsok/data/httpd/dev.schibstedsok.no_443/htdocs/maven/schibstedsok/wars/search-front-html/${target}/${svn.revision}"/>
    </goal>
    
    <goal name="continuum:continuum">
        
        <!-- Build the develop webapp with testing -->
        <attainGoal name="clean"/>
        <attainGoal name="test:test"/>
        
        <!-- turn testing off -->
        <j:set var="maven.test.skip" value="true"/>
        
        <!-- Build the searchdev war -->
        <attainGoal name="clean"/>
        <j:set var="target" value="searchdev"/>
        <attainGoal name="continuum:repository"/>
        
        <!-- Build the production war -->
        <attainGoal name="clean"/>
        <j:set var="target" value="production"/>
        <attainGoal name="continuum:repository"/>
        
        <!-- turn testing on again -->
        <j:set var="maven.test.skip" value="false"/>
        
        <!-- Build Maven website & deploy -->
        <j:set var="target" value="develop"/>
        <attainGoal name="site:deploy"/>
    </goal>
    
    
</project>
