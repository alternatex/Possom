<?xml version="1.0" encoding="UTF-8"?>
<!--
 - Copyright (2005-2006) Schibsted SÃ¸k AS
 - $Id$ 
-->
<project default="war:webapp" xmlns:j="jelly:core" xmlns:ant="jelly:ant" xmlns:maven="jelly:maven">

    <!-- Filter develop / production URLs -->
    <!-- Filter log4j paths -->
    <preGoal name="java:prepare-filesystem" >
        <ant:touch file="build.properties"/>
        <ant:filter filtersfile="build.properties" />
        <ant:filter filtersfile="${target}.properties" />
    </preGoal>

    <preGoal name="java:compile">
        <!-- JavaCC :: QueryParser -->
        <j:set var="maven.javacc.javacc.grammar" value="src/javacc/QueryParserImpl.jj"/>
        <j:set var="maven.javacc.javacc.package" value="no.schibstedsok.front.searchportal.query.parser"/>
        <attainGoal name="javacc:javacc-generate"/>
        <path id="javacc.generated.src" location="target/generated-src/main/java/no/schibstedsok/front/searchportal/query/parser"/> 
        <maven:addPath id="maven.compile.src.set" refid="javacc.generated.src"/>
    
        <!-- Axis -->
        <attainGoal name="axis:compile"/>
        
        <echo> ...java:compile preGoal finished.</echo>
    </preGoal>

    <goal name="deploy" prereqs="war:webapp" >
        <copy todir="${maven.tomcat.home}/webapps">
            <fileset dir="${maven.build.dir}">
                <include name="${pom.artifactId}/**"/>
            </fileset>
        </copy>
    </goal>
    
    <goal name="byggePaa.sch-dev01.dev" prereqs="site" >
        <copy todir="/www/schibstedsok/data/httpd/dev.schibstedsok.no_443/htdocs/maven/sites/search-front-html">
            <fileset dir="${maven.build.dir}/docs"/>
        </copy>
    </goal>
    
    
    <!-- 
      - 1) Keep junit tests logging to seperate files.
      - 2) Ensure search-front-config is available.
     -->
    <preGoal name="test:test-resources">
        <attainGoal name="ensure-config-running"/>
        <attainGoal name="alter-log4j-appenders-for-testing"/>
    </preGoal>
    <postGoal name="test:single"><attainGoal name="restore-log4j-appenders-for-testing"/></postGoal>
    <postGoal name="test:test"><attainGoal name="restore-log4j-appenders-for-testing"/></postGoal>
    
    <goal name="alter-log4j-appenders-for-testing">
        <ant:loadproperties srcFile="project.properties"/>
        <ant:loadproperties srcFile="${target}.properties"/>
        <ant:propertyfile file="target/classes/log4j.properties"> <!-- NEVER edit the original log4j.properties like this -->
          <ant:entry key="log4j.appender.LOG_APPEND.File"   value="${log.directory}/${log.file}.test.log" />
          <ant:entry key="log4j.appender.ERROR_APPEND.File" value="${log.directory}/${log.file}.test.error" />
          <ant:entry key="log4j.appender.DUMP_APPEND.File"  value="${log.directory}/${log.file}.test.dump" />
        </ant:propertyfile>
    </goal>
    <goal name="restore-log4j-appenders-for-testing">
        <ant:propertyfile file="target/classes/log4j.properties"> <!-- NEVER edit the original log4j.properties like this -->
          <ant:entry key="log4j.appender.LOG_APPEND.File"   value="${log.directory}/${log.file}.log" />
          <ant:entry key="log4j.appender.ERROR_APPEND.File" value="${log.directory}/${log.file}.error" />
          <ant:entry key="log4j.appender.DUMP_APPEND.File"  value="${log.directory}/${log.file}.dump" />
        </ant:propertyfile>
    </goal>
    
    <goal name="ensure-config-running">
        <!-- TODO how to test search-front-config is up and available? -->
    <!--
        <ant:junit failureproperty="search-front-config.unavailable">
            <test name="no.schibstedsok.front.searchportal.configuration.DefaultSiteSearchTabsCreatorTest"/>
        </ant:junit>
        <ant:fail if="search-front-config.unavailable"><br/>
            Unable to obtain configuration resources from search-front-config. 
            Please start this service before trying to build/deploy search-front-html.
        </ant:fail>
    -->
    </goal>
    
</project>
